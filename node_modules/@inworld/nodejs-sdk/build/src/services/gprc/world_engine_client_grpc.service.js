"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.WorldEngineClientGrpcService = void 0;
const grpc_js_1 = require("@grpc/grpc-js");
const world_engine_grpc_pb_1 = require("../../../../proto/world-engine_grpc_pb");
const world_engine_pb_1 = require("../../../../proto/world-engine_pb");
const util_1 = require("util");
const key_signature_1 = require("../../auth/key_signature");
const config_1 = require("../../common/config");
const constants_1 = require("../../common/constants");
const helpers_1 = require("../../common/helpers");
const logger_1 = require("../../common/logger");
class WorldEngineClientGrpcService {
    constructor() {
        this.config = config_1.Config.getInstance();
        this.address = this.config.getHost();
        this.ssl = this.config.getSsl();
        this.grpcOptions = Object.assign({}, helpers_1.grpcOptions);
        this.client = new world_engine_grpc_pb_1.WorldEngineClient(this.config.getHost(), this.ssl ? grpc_js_1.credentials.createSsl() : grpc_js_1.credentials.createInsecure(), Object.assign({}, helpers_1.grpcOptions));
        this.logger = logger_1.Logger.getInstance();
    }
    generateSessionToken(apiKey, scene) {
        return __awaiter(this, void 0, void 0, function* () {
            const metadata = new grpc_js_1.Metadata();
            const request = new world_engine_pb_1.GenerateTokenRequest();
            const resource = `workspaces/${constants_1.SCENE_PATTERN.exec(scene)[1]}`;
            request.setKey(apiKey.key);
            request.setResourcesList([resource]);
            metadata.add('authorization', key_signature_1.KeySignature.getAuthorization({
                apiKey,
                host: this.config.getHost(),
            }));
            return (0, util_1.promisify)(this.client.generateToken.bind(this.client))(request, metadata);
        });
    }
    loadScene(props) {
        var _a, _b, _c;
        return __awaiter(this, void 0, void 0, function* () {
            const { name, sessionToken, user, capabilities } = props;
            const request = new world_engine_pb_1.LoadSceneRequest();
            request.setName(name);
            request.setCapabilities(capabilities);
            if (user === null || user === void 0 ? void 0 : user.fullName) {
                request.setUser(new world_engine_pb_1.UserRequest().setName(user.fullName));
            }
            if ((_b = (_a = user === null || user === void 0 ? void 0 : user.profile) === null || _a === void 0 ? void 0 : _a.fields) === null || _b === void 0 ? void 0 : _b.length) {
                request.setUserSettings(new world_engine_pb_1.UserSettings().setPlayerProfile(new world_engine_pb_1.UserSettings.PlayerProfile().setFieldsList(user.profile.fields.map(({ id, value }) => new world_engine_pb_1.UserSettings.PlayerProfile.PlayerField()
                    .setFieldId(id)
                    .setFieldValue(value)))));
            }
            request.setClient(new world_engine_pb_1.ClientRequest().setId(((_c = props.client) === null || _c === void 0 ? void 0 : _c.getId()) || constants_1.CLIENT_ID));
            const metadata = this.getMetadata(sessionToken);
            const finalRequest = props.setLoadSceneProps
                ? props.setLoadSceneProps(request)
                : request;
            const response = yield (0, util_1.promisify)(this.client.loadScene.bind(this.client))(finalRequest, metadata);
            this.logger.debug({
                action: 'Load scene',
                data: {
                    address: this.address,
                    ssl: this.ssl,
                    grpcOptions: this.grpcOptions,
                    metadata: metadata.toJSON(),
                    request: request.toObject(),
                    response: response.toObject(),
                },
                sessionId: sessionToken.sessionId,
            });
            return response;
        });
    }
    session(props) {
        const { sessionToken, onDisconnect, onError, onMessage } = props;
        const metadata = this.getMetadata(sessionToken);
        const connection = this.client.session(metadata);
        this.logger.debug({
            action: 'Open session',
            data: {
                address: this.address,
                ssl: this.ssl,
                grpcOptions: this.grpcOptions,
                metadata: metadata.toJSON(),
            },
            sessionId: sessionToken.sessionId,
        });
        if (onMessage) {
            connection.on('data', onMessage);
        }
        if (onDisconnect) {
            connection.on('close', onDisconnect);
        }
        if (onError) {
            connection.on('error', (err) => {
                onError(err);
                connection.end();
            });
        }
        return connection;
    }
    getMetadata(sessionToken) {
        const metadata = new grpc_js_1.Metadata();
        metadata.add('session-id', sessionToken.sessionId);
        metadata.add('authorization', `${sessionToken.type} ${sessionToken.token}`);
        return metadata;
    }
}
exports.WorldEngineClientGrpcService = WorldEngineClientGrpcService;
